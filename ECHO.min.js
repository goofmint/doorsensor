/**
 * ECHO-JavaScript-SDK v1.0.0
 * Released at 2015/07/15
 *
 * Copyright 2015 NeuroBASE,Inc. All Rights Reserved.
 * This is freely distributable under the MIT license.
 *
 * Created based on the following Javascript libraries.
 *
 * Includes: node-XMLHttpRequest
 * @author Dan DeFelippi <dan@driverdan.com>
 * @contributor David Ellis <d.f.ellis@ieee.org>
 * @license MIT
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, 
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF 
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. 
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, 
 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, 
 * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH 
 * THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. 
 */
(function(){var ECHO,ECHOContentsObject,ECHODataObject,ECHODistributedObject,ECHOObject,ECHOQuery,ECHOTreeMap,dateFromString,stringFromDate,typeIsArray,typeIsString,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;ECHOQuery=function(){function ECHOQuery(){}ECHOQuery.find=function(instanceId,resourceType,params,listKey){var promise,promise2;promise=ECHOQuery.request("GET","/"+instanceId+"/"+resourceType,params);promise2=new ECHO.Promise;promise.then(function(retObj){var j,len,obj,objList,ref;if((retObj!=null?retObj[listKey]:void 0)==null){return promise2.reject(new Error("Invalid data type for response-field `"+listKey+"`."))}objList=new ECHO.List(retObj.paginate);ref=retObj[listKey];for(j=0,len=ref.length;j<len;j++){obj=ref[j];objList.push(ECHODataObject.factory(obj))}return promise2.resolve(objList)},function(error){return promise2.reject(error)});return promise2};ECHOQuery.request=function(method,path,data,multipart){var FormData,buildRequestContents,data2,flag,formData,makeQueryString,promise,query,reqMethod,xhr;if(multipart==null){multipart=false}if(typeof module!=="undefined"&&module!==null?module.exports:void 0){FormData=require("form-data")}else{FormData=window.FormData}promise=new ECHO.Promise;xhr=new XMLHttpRequest;flag=0;xhr.onreadystatechange=function(){var detail,e,errorObj,key,ref,res;if(xhr.readyState===4){if(xhr.status>=200&&xhr.status<300){flag=1}else if(xhr.status){flag=-1}if(flag!==0){try{res=JSON.parse(xhr.responseText)}catch(_error){e=_error;if(flag===1){promise.reject(new ECHO.Error(ECHO.Error.INVALID_JSON_FORMAT,"Invalid JSON format."))}else{promise.reject(new Error(xhr.responseText))}return null}if(flag===1){promise.resolve(res)}else{if(res.error_code!=null&&res.error_message!=null){errorObj=new ECHO.Error(res.error_code,res.error_message);if(res.error_details!=null&&res.error_details instanceof Object){ref=res.error_details;for(key in ref){detail=ref[key];if(key!=null&&detail.error_code!=null&&detail.error_message!=null){errorObj.setErrorDetail(key,detail.error_code,detail.error_message)}}}}else{errorObj=new Error("An unknown error has occurred.")}promise.reject(errorObj)}return null}}};reqMethod=multipart?"POST":method;makeQueryString=function(obj){var key,str,val,val2;str="?";for(key in obj){val=obj[key];if(val instanceof Object){val2=JSON.stringify(val)}else{val2=val}str+=key+"="+val2+"&"}return str.substr(0,str.length-1)};query=method==="GET"?makeQueryString(data):"";xhr.open(reqMethod,"https://"+ECHO.secureDomain+path+"/rest_api=1.0/"+query,true);if(!(ECHO.appId!=null&&ECHO.appKey!=null)){throw new Error("The SDK is not initialized. Please call `ECHO.initialize()`.")}xhr.setRequestHeader("X-ECHO-APP-ID",ECHO.appId);xhr.setRequestHeader("X-ECHO-APP-KEY",ECHO.appKey);if(ECHO.accessToken!=null){xhr.setRequestHeader("X-ECHO-ACCESS-TOKEN",ECHO.accessToken)}if(multipart){buildRequestContents=function(data,currentKeys,formData){var boundary,content,filename,i,j,k,key,l,len,len1,name,newKeys,ref,val;if(!(data instanceof Object)){return null}for(key in data){val=data[key];newKeys=[];for(j=0,len=currentKeys.length;j<len;j++){k=currentKeys[j];newKeys.push(k)}newKeys.push(key);name="";for(i=l=0,len1=newKeys.length;l<len1;i=++l){k=newKeys[i];name+=i===0?k:"["+k+"]"}if(val instanceof ECHO.File){filename=(ref=val.name)!=null?ref:"blob";if(typeof module!=="undefined"&&module!==null?module.exports:void 0){boundary="--"+formData.getBoundary();formData.append(name,val.file,{header:boundary+"\r\n"+('Content-Disposition: form-data; name="'+name+'"; filename="'+filename+'"\r\n')+"Content-Type: "+val.getMimeType()+"\r\n\r\n"})}else{formData.append(name,val.file,filename)}}else if(val instanceof Object){buildRequestContents(val,newKeys,formData)}else if(val!=null){content="";if(val instanceof Boolean){content=val?"true":""}else{content=val}formData.append(name,content)}}return null};data2={};data2["method"]=method;data2["data"]=data;formData=new FormData;buildRequestContents(data2,[],formData);xhr.send(formData)}else{xhr.setRequestHeader("Content-Type","application/json");data=JSON.stringify(data||{});xhr.send(data)}return promise};return ECHOQuery}();ECHOObject=function(){ECHOObject.prototype.instanceId=null;ECHOObject.prototype.resourceType=null;ECHOObject.prototype.refid=null;function ECHOObject(instanceId1,resourceType1,refid1){this.instanceId=instanceId1;this.resourceType=resourceType1;this.refid=refid1!=null?refid1:null}ECHOObject.prototype.getRequestUrl=function(){var path;path="/"+this.instanceId+"/"+this.resourceType;if(this.refid!=null){path+="/"+this.refid}return path};return ECHOObject}();ECHODataObject=function(superClass){extend(ECHODataObject,superClass);ECHODataObject.factory=function(data){var instanceId,obj,ref,ref1,ref2,refid,resourceType,sUrl;refid=(ref=data!=null?data.refid:void 0)!=null?ref:null;resourceType=(ref1=data!=null?data.resource_type:void 0)!=null?ref1:null;sUrl=data!=null?(ref2=data.url_path)!=null?ref2.split("/"):void 0:void 0;if((sUrl!=null?sUrl[1]:void 0)!=null){instanceId=sUrl[1]}if(refid==null||!refid){return null}if(instanceId==null||!instanceId){return null}obj=null;switch(resourceType){case"entry":obj=new ECHO.Blogs.EntryObject(instanceId,refid,data);break;case"record":obj=new ECHO.Databases.RecordObject(instanceId,refid,data);break;case"member":obj=new ECHO.Members.MemberObject(instanceId,refid,data)}return obj};function ECHODataObject(instanceId,resourceType,refid,data){if(refid==null){refid=null}if(data==null){data=null}ECHODataObject.__super__.constructor.call(this,instanceId,resourceType,refid);this._data={};this._newACL=null;this._currentACL=null;this._multipart=false;if(data!=null){this._copyData(data)}}ECHODataObject.prototype.fetch=function(){var promise,promise2;promise=ECHOQuery.request("GET",this.getRequestUrl(),null);promise2=new ECHO.Promise;promise.then(function(_this){return function(retObj){_this._copyData(retObj);return promise2.resolve(_this)}}(this),function(error){return promise2.reject(error)});return promise2};ECHODataObject.prototype.push=function(){var data,method,promise,promise2;data=this._buildRequestContents();method=this.refid?"PUT":"POST";promise=ECHOQuery.request(method,this.getRequestUrl(),data,this._multipart);promise2=new ECHO.Promise;promise.then(function(_this){return function(retObj){_this._copyData(retObj);_this.refid=retObj.refid;return promise2.resolve(_this)}}(this),function(error){return promise2.reject(error)});return promise2};ECHODataObject.prototype["delete"]=function(){var promise,promise2;promise=ECHOQuery.request("DELETE",this.getRequestUrl(),null);promise2=new ECHO.Promise;promise.then(function(_this){return function(retObj){_this.refid=null;return promise2.resolve(_this)}}(this),function(error){return promise2.reject(error)});return promise2};ECHODataObject.prototype.get=function(key){var nestedGet;nestedGet=function(_this){return function(obj,keys){key=keys.shift();if(obj[key]instanceof Object&&keys.length>0){return nestedGet(obj[key],keys)}else{return obj[key]}}}(this);return nestedGet(this._data,key.split("."))};ECHODataObject.prototype.put=function(key,value){var nestedPut;this._data[key]=value;return null;nestedPut=function(_this){return function(obj,keys,val){key=keys.shift();if(obj instanceof Object&&keys.length>0){if(obj[key]!=null){obj[key]={}}return nestedPut(obj[key],keys,val)}else{return obj=val}}}(this);nestedPut(this._data,key.split(".",value));console.log("----------------");console.log(key);console.log(value);return console.log(this._data)};ECHODataObject.prototype.getACL=function(){return this._currentACL};ECHODataObject.prototype.setNewACL=function(newACL){return this._newACL=newACL};ECHODataObject.prototype._copyData=function(data){var ignored,j,key,key2,len,ref,val,val2;if(!(data instanceof Object)){return null}if(data.created!=null){try{data.created=dateFromString(data.created)}catch(_error){ignored=_error}}if(data.modified!=null){try{data.modified=dateFromString(data.modified)}catch(_error){ignored=_error}}if(data.acl instanceof Object){this._currentACL=new ECHO.ACL(data.acl);delete data.acl}if(data.contents instanceof Object){ref=data.contents;for(key in ref){val=ref[key];if(typeIsArray(val)){for(key2=j=0,len=val.length;j<len;key2=++j){val2=val[key2];data.contents[key][key2]=this._convertContentsInCopyData(val2)}}else{data.contents[key]=this._convertContentsInCopyData(val)}}}this._data=data;return null};ECHODataObject.prototype._convertContentsInCopyData=function(val){var file,ignored;if((val!=null?val._type:void 0)!=null){switch(val._type){case"file":file=new ECHO.File;file.setRemoteFile(val);return file;case"instance":return ECHODataObject.factory(val)}}else if(typeIsString(val)&&val.length===19){try{return dateFromString(val)}catch(_error){ignored=_error}}return val};ECHODataObject.prototype._buildRequestContents=function(){var data,j,key,key2,key3,len,ref,ref1,val,val2,val3;this._multipart=false;data={};if(this._newACL!=null){data.acl=(ref=this._newACL)!=null?typeof ref.toObject==="function"?ref.toObject():void 0:void 0}ref1=this._data;for(key in ref1){val=ref1[key];if(key==="modified"||key==="created"){continue}else if(key==="contents"){if(!(val instanceof Object)){continue}data.contents={};for(key2 in val){val2=val[key2];if(typeIsArray(val2)){data.contents[key2]=[];for(key3=j=0,len=val2.length;j<len;key3=++j){val3=val2[key3];data.contents[key2][key3]=this._convertContentsInBuildRequest(val3)}}else{data.contents[key2]=this._convertContentsInBuildRequest(val2)}}}else{data[key]=val}}return data};ECHODataObject.prototype._convertContentsInBuildRequest=function(val){if(val instanceof ECHO.File){if(val.file!=null){this._multipart=true}else{return null}}else if(val instanceof ECHODataObject){if(val.refid!=null){return val.refid}else{return null}}else if(val instanceof Date){val=stringFromDate(val)}return val};return ECHODataObject}(ECHOObject);ECHOContentsObject=function(superClass){extend(ECHOContentsObject,superClass);function ECHOContentsObject(){return ECHOContentsObject.__super__.constructor.apply(this,arguments)}ECHOContentsObject.prototype._copyData=function(data){var category,i,j,len,ref;if(data.categories==null){return null}ref=data.categories;for(i=j=0,len=ref.length;j<len;i=++j){category=ref[i];if(category.refid!=null){data.categories[i]=new ECHO.ContentsCategoryObject(this.instanceId,category.refid,category)}}ECHOContentsObject.__super__._copyData.call(this,data);return null};ECHOContentsObject.prototype._buildRequestContents=function(){var category,data,i,j,len,ref;data=ECHOContentsObject.__super__._buildRequestContents.call(this);if(data.categories!=null){ref=data.categories;for(i=j=0,len=ref.length;j<len;i=++j){category=ref[i];if(category.refid!=null){data.categories[i]=category.refid}}}return data};return ECHOContentsObject}(ECHODataObject);ECHOTreeMap=function(superClass){extend(ECHOTreeMap,superClass);ECHOTreeMap.prototype.node=null;ECHOTreeMap.prototype.children=null;function ECHOTreeMap(instanceId,resourceType,refid,data){if(refid==null){refid=null}if(data==null){data=null}ECHOTreeMap.__super__.constructor.call(this,instanceId,resourceType,refid);this._isSubtree=refid!=null?true:false;if(data!=null){this._copyData(data)}}ECHOTreeMap.prototype.fetch=function(){var promise,promise2;promise=ECHOQuery.request("GET",this.getRequestUrl(),null);promise2=new ECHO.Promise;promise.then(function(_this){return function(retObj){_this._copyData(retObj);return promise2.resolve(_this)}}(this),function(error){return promise2.reject(error)});return promise2};return ECHOTreeMap}(ECHOObject);ECHODistributedObject=function(superClass){extend(ECHODistributedObject,superClass);function ECHODistributedObject(){return ECHODistributedObject.__super__.constructor.apply(this,arguments)}ECHODistributedObject.prototype.resetTarget=function(){return this._data.target={}};ECHODistributedObject.prototype.targetAllMembers=function(){return this._data.target={members:"*"}};ECHODistributedObject.prototype.targetRootGroup=function(){if(this._data.target==null){this._data.target={}}return this._data.target.groups="*"};ECHODistributedObject.prototype.targetSpecificMember=function(member){if(!(member instanceof ECHO.Members.MemberObject&&member.instanceId!=null&&member.instanceId&&member.refid!=null&&member.refid)){throw new TypeError("Invalid data type for argument `member`.")}if(this._data.target==null){this._data.target={}}if(!typeIsArray(this._data.target.members!=null)){this._data.target.members=[]}return this._data.target.members.push(member)};ECHODistributedObject.prototype.targetSpecificGroup=function(group){if(!(group instanceof ECHO.Members.GroupObject&&group.instanceId!=null&&group.instanceId&&group.refid!=null&&group.refid)){throw new TypeError("Invalid data type for argument `group`.")}if(this._data.target==null){this._data.target={}}if(!typeIsArray(this._data.target.groups!=null)){this._data.target.groups=[]}return this._data.target.groups.push(group)};ECHODistributedObject.prototype._copyData=function(data){var i,j,l,len,len1,ref,ref1,refid,targetGroups,targetMembers;if(data.distributed!=null){data.distributed=dateFromString(data.distributed)}if(data.target!=null){if(typeIsArray(data.target.members)){targetMembers=[];ref=data.target.members;for(i=j=0,len=ref.length;j<len;i=++j){refid=ref[i];if(refid==="*"){data.target.members="*";break}else if(refid.length>0){targetMembers.push(new ECHO.Members.MemberObject(this.instanceId,refid))}}data.target.members=targetMembers}else if(data.target.members==="*"){data.target.members="*"}if(typeIsArray(data.target.groups)){targetGroups=[];ref1=data.target.groups;for(i=l=0,len1=ref1.length;l<len1;i=++l){refid=ref1[i];if(refid==="*"){data.target.groups="*";break}else if(refid.length>0){targetGroups.push(new ECHO.Members.GroupObject(this.instanceId,refid))}}data.target.groups=targetGroups}else if(data.target.groups==="*"){data.target.groups="*"}}ECHODistributedObject.__super__._copyData.call(this,data);return null};ECHODistributedObject.prototype._buildRequestContents=function(){var data,group,i,j,l,len,len1,member,ref,ref1,ref2,ref3,targetGroups,targetMembers;data=ECHODistributedObject.__super__._buildRequestContents.call(this);if((data.distributed!=null)instanceof Date){data.distributed=stringFromDate(data.distributed)}if(((ref=data.target)!=null?ref.members:void 0)!=null||((ref1=data.target)!=null?ref1.groups:void 0)!=null){if(typeIsArray(data.target.members)){targetMembers=[];ref2=data.target.members;for(i=j=0,len=ref2.length;j<len;i=++j){member=ref2[i];if(member instanceof ECHO.Members.MemberObject){if(member.refid.length>0){targetMembers.push(member.refid)}}else if(member==="*"){data.target.members="*";break}}data.target.members=targetMembers}if(typeIsArray(data.target.groups)){targetGroups=[];ref3=data.target.groups;for(i=l=0,len1=ref3.length;l<len1;i=++l){group=ref3[i];if(group instanceof ECHO.Members.GroupObject){if(group.refid.length>0){targetGroups.push(group.refid)}}else if(group==="*"){data.target.groups="*";break}}data.target.groups=targetGroups}}return data};return ECHODistributedObject}(ECHODataObject);ECHO=function(){function ECHO(){}ECHO.secureDomain=null;ECHO.appId=null;ECHO.appKey=null;ECHO.accessToken=null;ECHO.initialize=function(secureDomain,appId,appKey){if(secureDomain==null||!secureDomain){throw new TypeError("argument `secureDomain` must not be null.")}if(appId==null||!appId){throw new TypeError("argument `appId` must not be null.")}if(appKey==null||!appKey){throw new TypeError("argument `appKey` must not be null.")}ECHO.secureDomain=secureDomain;ECHO.appId=appId;ECHO.appKey=appKey};return ECHO}();ECHO.List=function(superClass){extend(List,superClass);List.prototype.page=null;List.prototype.prevPage=null;List.prototype.nextPage=null;List.prototype.pageCount=null;List.prototype.count=null;List.prototype.limit=null;List.prototype.order=null;List.prototype.asc=null;function List(data){if(!(data instanceof Object)){throw new TypeError("Invalid data type for argument `data`.")}List.__super__.constructor.call(this);this.page=data.page;this.prevPage=data.prevPage;this.nextPage=data.nextPage;this.pageCount=data.pageCount;this.count=data.count;this.limit=data.limit;this.order=data.order;this.asc=data.asc}return List}(Array);ECHO.Error=function(superClass){extend(Error,superClass);Error.APPID_NOT_SPECIFIED=100010;Error.APPKEY_NOT_SPECIFIED=100020;Error.INVALID_API_APPLICATION=100030;Error.RESOURCE_NOT_FOUND=110010;Error.NOTFOUND_OR_FORBIDDEN=110020;Error.METHOD_NOT_ALLOWED=110030;Error.UNSUPPORTED_MEDIA_TYPE=110040;Error.INVALID_JSON_FORMAT=110050;Error.OPERATION_NOT_PERMITTED=13e4;Error.AUTHENTICATION_ERROR=130010;Error.ACCESSTOKEN_INCORRECTED_OR_EXPIRED=130020;Error.READ_ONLY=130030;Error.VALIDATION_ERRORS_OCCURRED=15e4;Error.NOT_SET=150010;Error.CONTAINED_RESTRICTED_CHARACTER=150020;Error.TOO_LONG=150030;Error.TOO_SHORT=150031;Error.NON_UNIQUE=150040;Error.CONTAINED_NON_NUMERIC_CHARACTER=150050;Error.EXCEED_ACCEPTABLE_RANGE=150051;Error.NOT_A_PERCENTAGE=150052;Error.INVALID_EMAIL_FORMAT=150060;Error.REFERENCE_LOOPED=150070;Error.INVALID_PHONE_NUMBER_FORMAT=150080;Error.INVALID_DATE_STRING_FORMAT=150090;Error.INVALID_ZIPCODE_FORMAT=150100;Error.REFERENCE_NOT_EXIST=150110;Error.INVALID_PREF_FORMAT=150120;Error.INVALID_VALUE=150130;Error.INVALID_FIELD_REFID=150140;Error.prototype.name="ECHO.Error";Error.prototype.code=null;Error.prototype.message=null;Error.prototype.details={};function Error(code1,message1){this.code=code1;this.message=message1;this.details={};Error.__super__.constructor.call(this)}Error.prototype.setErrorDetail=function(key,code,message){return this.details[key]=new ECHO.Error(code,message)};return Error}(Error);ECHO.File=function(){function File(name1,file1,mimeType){this.name=name1!=null?name1:null;this.file=file1!=null?file1:null;this.mimeType=mimeType!=null?mimeType:null;this.url=null}File.prototype.setRemoteFile=function(data){this.name=data.name;return this.url=data.url};File.prototype.getMimeType=function(){var extension,ref,ref1;if(this.mimeType!=null&&this.mimeType){return this.mimeType}extension=/\.([^.]*)$/.exec((ref=this.name)!=null?ref:"");if(extension){extension=extension[1].toLowerCase()}return(ref1=ECHO.File.mimeTypes[extension])!=null?ref1:"text/plain"};File.mimeTypes={ai:"application/postscript",aif:"audio/x-aiff",aifc:"audio/x-aiff",aiff:"audio/x-aiff",asc:"text/plain",atom:"application/atom+xml",au:"audio/basic",avi:"video/x-msvideo",bcpio:"application/x-bcpio",bin:"application/octet-stream",bmp:"image/bmp",cdf:"application/x-netcdf",cgm:"image/cgm","class":"application/octet-stream",cpio:"application/x-cpio",cpt:"application/mac-compactpro",csh:"application/x-csh",css:"text/css",dcr:"application/x-director",dif:"video/x-dv",dir:"application/x-director",djv:"image/vnd.djvu",djvu:"image/vnd.djvu",dll:"application/octet-stream",dmg:"application/octet-stream",dms:"application/octet-stream",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",dotx:"application/vnd.openxmlformats-officedocument.wordprocessingml.template",docm:"application/vnd.ms-word.document.macroEnabled.12",dotm:"application/vnd.ms-word.template.macroEnabled.12",dtd:"application/xml-dtd",dv:"video/x-dv",dvi:"application/x-dvi",dxr:"application/x-director",eps:"application/postscript",etx:"text/x-setext",exe:"application/octet-stream",ez:"application/andrew-inset",gif:"image/gif",gram:"application/srgs",grxml:"application/srgs+xml",gtar:"application/x-gtar",hdf:"application/x-hdf",hqx:"application/mac-binhex40",htm:"text/html",html:"text/html",ice:"x-conference/x-cooltalk",ico:"image/x-icon",ics:"text/calendar",ief:"image/ief",ifb:"text/calendar",iges:"model/iges",igs:"model/iges",jnlp:"application/x-java-jnlp-file",jp2:"image/jp2",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"application/x-javascript",kar:"audio/midi",latex:"application/x-latex",lha:"application/octet-stream",lzh:"application/octet-stream",m3u:"audio/x-mpegurl",m4a:"audio/mp4a-latm",m4b:"audio/mp4a-latm",m4p:"audio/mp4a-latm",m4u:"video/vnd.mpegurl",m4v:"video/x-m4v",mac:"image/x-macpaint",man:"application/x-troff-man",mathml:"application/mathml+xml",me:"application/x-troff-me",mesh:"model/mesh",mid:"audio/midi",midi:"audio/midi",mif:"application/vnd.mif",mov:"video/quicktime",movie:"video/x-sgi-movie",mp2:"audio/mpeg",mp3:"audio/mpeg",mp4:"video/mp4",mpe:"video/mpeg",mpeg:"video/mpeg",mpg:"video/mpeg",mpga:"audio/mpeg",ms:"application/x-troff-ms",msh:"model/mesh",mxu:"video/vnd.mpegurl",nc:"application/x-netcdf",oda:"application/oda",ogg:"application/ogg",pbm:"image/x-portable-bitmap",pct:"image/pict",pdb:"chemical/x-pdb",pdf:"application/pdf",pgm:"image/x-portable-graymap",pgn:"application/x-chess-pgn",pic:"image/pict",pict:"image/pict",png:"image/png",pnm:"image/x-portable-anymap",pnt:"image/x-macpaint",pntg:"image/x-macpaint",ppm:"image/x-portable-pixmap",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",potx:"application/vnd.openxmlformats-officedocument.presentationml.template",ppsx:"application/vnd.openxmlformats-officedocument.presentationml.slideshow",ppam:"application/vnd.ms-powerpoint.addin.macroEnabled.12",pptm:"application/vnd.ms-powerpoint.presentation.macroEnabled.12",potm:"application/vnd.ms-powerpoint.template.macroEnabled.12",ppsm:"application/vnd.ms-powerpoint.slideshow.macroEnabled.12",ps:"application/postscript",qt:"video/quicktime",qti:"image/x-quicktime",qtif:"image/x-quicktime",ra:"audio/x-pn-realaudio",ram:"audio/x-pn-realaudio",ras:"image/x-cmu-raster",rdf:"application/rdf+xml",rgb:"image/x-rgb",rm:"application/vnd.rn-realmedia",roff:"application/x-troff",rtf:"text/rtf",rtx:"text/richtext",sgm:"text/sgml",sgml:"text/sgml",sh:"application/x-sh",shar:"application/x-shar",silo:"model/mesh",sit:"application/x-stuffit",skd:"application/x-koan",skm:"application/x-koan",skp:"application/x-koan",skt:"application/x-koan",smi:"application/smil",smil:"application/smil",snd:"audio/basic",so:"application/octet-stream",spl:"application/x-futuresplash",src:"application/x-wais-source",sv4cpio:"application/x-sv4cpio",sv4crc:"application/x-sv4crc",svg:"image/svg+xml",swf:"application/x-shockwave-flash",t:"application/x-troff",tar:"application/x-tar",tcl:"application/x-tcl",tex:"application/x-tex",texi:"application/x-texinfo",texinfo:"application/x-texinfo",tif:"image/tiff",tiff:"image/tiff",tr:"application/x-troff",tsv:"text/tab-separated-values",txt:"text/plain",ustar:"application/x-ustar",vcd:"application/x-cdlink",vrml:"model/vrml",vxml:"application/voicexml+xml",wav:"audio/x-wav",wbmp:"image/vnd.wap.wbmp",wbmxl:"application/vnd.wap.wbxml",wml:"text/vnd.wap.wml",wmlc:"application/vnd.wap.wmlc",wmls:"text/vnd.wap.wmlscript",wmlsc:"application/vnd.wap.wmlscriptc",wrl:"model/vrml",xbm:"image/x-xbitmap",xht:"application/xhtml+xml",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xltx:"application/vnd.openxmlformats-officedocument.spreadsheetml.template",xlsm:"application/vnd.ms-excel.sheet.macroEnabled.12",xltm:"application/vnd.ms-excel.template.macroEnabled.12",xlam:"application/vnd.ms-excel.addin.macroEnabled.12",xlsb:"application/vnd.ms-excel.sheet.binary.macroEnabled.12",xslt:"application/xslt+xml",xul:"application/vnd.mozilla.xul+xml",xwd:"image/x-xwindowdump",xyz:"chemical/x-xyz",zip:"application/zip"};return File}();ECHO.Promise=function(){function Promise(){this._resolved=false;this._rejected=false;this._resolvedCallbacks=[];this._rejectedCallbacks=[];this._error=null;this._result=null}Promise.is=function(promise){return typeof(promise!=null?promise.then:void 0)==="function"};Promise.as=function(){var promise;promise=new ECHO.Promise;promise.resolve.apply(promise,arguments);return promise};Promise.error=function(){var promise;promise=new ECHO.Promise;promise.reject.apply(promise,arguments);return promise};Promise.when=function(promises){var errors,hadError,i,j,len,object,objects,promise,resolveOne,results,total;if((promises!=null?promises.length:void 0)!=null){objects=promises}else{objects=arguments}total=objects.length;hadError=false;results=[];errors=[];results.length=objects.length;errors.length=objects.length;if(total===0){return ECHO.Promise.as.apply(this,results)}promise=new ECHO.Promise;resolveOne=function(){total=total-1;if(total===0){if(hadError){return promise.reject(errors)}else{return promise.resolve.apply(promise,results)}}};for(i=j=0,len=objects.length;j<len;i=++j){object=objects[i];if(ECHO.Promise.is(object)){object.then(function(result){results[i]=result;return resolveOne()},function(error){errors[i]=error;hadError=true;return resolveOne()})}else{results[i]=object;resolveOne()}}return promise};Promise.prototype.resolve=function(result){var j,len,ref,ref1,resolvedCallback;if(this._resolved||this._rejected){throw new Error((ref="The promise had already been"+this._resolved)!=null?ref:{resolved:"rejected"+"."})}this._resolved=true;this._result=arguments;ref1=this._resolvedCallbacks;for(j=0,len=ref1.length;j<len;j++){resolvedCallback=ref1[j];resolvedCallback.apply(this,this._result)}this._resolvedCallbacks=[];return this._rejectedCallbacks=[]};Promise.prototype.reject=function(error){var j,len,ref,ref1,rejectedCallback;if(this._resolved||this._rejected){throw new Error((ref="The promise had already been"+this._resolved)!=null?ref:{resolved:"rejected"+"."})}this._rejected=true;this._error=error;ref1=this._rejectedCallbacks;for(j=0,len=ref1.length;j<len;j++){rejectedCallback=ref1[j];rejectedCallback(error)}this._resolvedCallbacks=[];return this._rejectedCallbacks=[]};Promise.prototype.then=function(resolvedCallback,rejectedCallback){var promise,wrappedRejectedCallback,wrappedResolvedCallback;promise=new ECHO.Promise;wrappedResolvedCallback=function(){var result;result=arguments;if(resolvedCallback){result=[resolvedCallback.apply(this,result)]}if(result.length===1&&ECHO.Promise.is(result[0])){return result[0].then(function(){return promise.resolve.apply(promise,arguments)},function(error){return promise.reject.apply(promise,error)})}else{return promise.resolve.apply(promise,result)}};wrappedRejectedCallback=function(error){var result;result=[];if(rejectedCallback){result=[rejectedCallback(error)];if(result.length===1&&ECHO.Promise.is(result[0])){return result[0].then(function(){return promise.resolve.apply(promise,arguments)},function(error){return promise.reject(error)})}else{return promise.reject(result[0])}}else{return promise.reject(error)}};if(this._resolved){wrappedResolvedCallback.apply(this,this._result)}else if(this._rejected){wrappedRejectedCallback(this._error)}else{this._resolvedCallbacks.push(wrappedResolvedCallback);this._rejectedCallbacks.push(wrappedRejectedCallback)}return promise};return Promise}();ECHO.ACL=function(){function ACL(aclObj){if(aclObj==null){aclObj=null}this._all=null;this._allMembers={};this._specificGroups={};this._specificMembers={};if(aclObj!=null){this._copyData(aclObj)}}ACL.prototype.getEntryForAll=function(){return this._all};ACL.prototype.putEntryForAll=function(entry){this._checkACLEntry(entry);this._all=entry;return null};ACL.prototype.resetEntryForAll=function(){this._all=null;return null};ACL.prototype.getEntryForAllMembers=function(memberInstanceId){var ref;this._checkMemberInstanceId(memberInstanceId);return(ref=this._allMembers[memberInstanceId])!=null?ref:null};ACL.prototype.putEntryForAllMembers=function(memberInstanceId,entry){this._checkMemberInstanceId(memberInstanceId);this._checkACLEntry(entry);this._allMembers[memberInstanceId]=entry;return null};ACL.prototype.resetEntryForAllMembers=function(memberInstanceId){this._checkMemberInstanceId(memberInstanceId);delete this._allMembers[memberInstanceId];return null};ACL.prototype.getEntryForSpecificGroup=function(group){var hash,ref;hash=this._checkGroupObject(group);return(ref=this._specificGroups[hash])!=null?ref:null};ACL.prototype.putEntryForSpecificGroup=function(group,entry){var hash;hash=this._checkGroupObject(group);this._checkACLEntry(entry);this._specificGroups[hash]=entry;return null};ACL.prototype.resetEntryForSpecificGroup=function(group){var hash;hash=this._checkGroupObject(group);delete this._specificGroups[hash];return null};ACL.prototype.getEntryForSpecificMember=function(member){var hash,ref;hash=this._checkMemberObject(member);return(ref=this._specificMembers[hash])!=null?ref:null};ACL.prototype.putEntryForSpecificMember=function(member,entry){var hash;hash=this._checkMemberObject(member);this._checkACLEntry(entry);this._specificMembers[hash]=entry;return null};ACL.prototype.resetEntryForSpecificMember=function(member){var hash;hash=this._checkMemberObject(member);delete this._specificMembers[hash];return null};ACL.prototype.toObject=function(){var e,key,obj,ref,ref1,ref2,ref3,s;obj={};obj["*"]=(ref=this._all)!=null?typeof ref.toObject==="function"?ref.toObject():void 0:void 0;ref1=this._allMembers;for(key in ref1){e=ref1[key];if(obj[key]==null){obj[key]={}}obj[key]["*"]=e!=null?typeof e.toObject==="function"?e.toObject():void 0:void 0}ref2=this._specificGroups;for(key in ref2){e=ref2[key];s=key.split("/");if(s[0]==null||s[1]==null||!s[0]||!s[1]){continue}if(obj[s[0]]==null){obj[s[0]]={}}if(obj[s[0]]["groups"]==null){obj[s[0]]["groups"]={}}obj[s[0]]["groups"][s[1]]=typeof e.toObject==="function"?e.toObject():void 0}ref3=this._specificMembers;for(key in ref3){e=ref3[key];s=key.split("/");if(s[0]==null||s[1]==null||!s[0]||!s[1]){continue}if(obj[s[0]]==null){obj[s[0]]={}}if(obj[s[0]]["members"]==null){obj[s[0]]["members"]={}}obj[s[0]]["members"][s[1]]=typeof e.toObject==="function"?e.toObject():void 0}return obj};ACL.prototype._copyData=function(aclObj){var e,e2,e3,group,key,key2,key3,member,results1;if(typeof aclObj!=="object"){return null}results1=[];for(key in aclObj){e=aclObj[key];if(key==="*"){results1.push(this.putEntryForAll(new ECHO.ACL.Entry(e)))}else{results1.push(function(){var results2;results2=[];for(key2 in e){e2=e[key2];if(key2==="*"){results2.push(this.putEntryForAllMembers(key,new ECHO.ACL.Entry(e2)))}else{results2.push(function(){var results3;results3=[];for(key3 in e2){e3=e2[key3];if(key2==="members"){member=new ECHO.Members.MemberObject(key,key3);results3.push(this.putEntryForSpecificMember(member,new ECHO.ACL.Entry(e3)))}else if(key2==="groups"){group=new ECHO.Members.GroupObject(key,key3);results3.push(this.putEntryForSpecificGroup(group,new ECHO.ACL.Entry(e3)))}else{results3.push(void 0)}}return results3}.call(this))}}return results2}.call(this))}}return results1};ACL.prototype._checkMemberInstanceId=function(memberInstanceId){if(memberInstanceId==null||!typeIsString(memberInstanceId)||!memberInstanceId){throw new TypeError("Invalid data type for argument `memberInstanceId`.")}};ACL.prototype._checkACLEntry=function(entry){if(!(entry instanceof ECHO.ACL.Entry)){throw new TypeError("Invalid data type for argument `entry`.")}};ACL.prototype._checkGroupObject=function(group){if(!(group instanceof ECHO.Members.GroupObject&&group.instanceId!=null&&group.instanceId&&group.refid!=null&&group.refid)){throw new TypeError("Invalid data type for argument `group`.")}return group.instanceId+"/"+group.refid};ACL.prototype._checkMemberObject=function(member){if(!(member instanceof ECHO.Members.MemberObject&&member.instanceId!=null&&member.instanceId&&member.refid!=null&&member.refid)){throw new TypeError("Invalid data type for argument `member`.")}return member.instanceId+"/"+member.refid};return ACL}();ECHO.ACL.Entry=function(){function Entry(get,list,edit,_delete){var obj,ref,ref1,ref2,ref3;this.get=get;this.list=list;this.edit=edit;this["delete"]=_delete;if(this.get instanceof Object){obj=this.get;this.get=(ref=obj.get)!=null?ref:false;

this.list=(ref1=obj.list)!=null?ref1:false;this.edit=(ref2=obj.edit)!=null?ref2:false;this["delete"]=(ref3=obj["delete"])!=null?ref3:false}}Entry.prototype.toObject=function(){return{get:this.get,list:this.list,edit:this.edit,"delete":this["delete"]}};return Entry}();ECHO.Installation=function(){function Installation(data){if(data==null){data=null}this.deviceType=null;this.deviceToken=null;if(data!=null){this._copyData(data)}}Installation.prototype.toObject=function(){return{device_type:this.deviceType,device_token:this.deviceToken}};Installation.prototype._copyData=function(data){if(typeof data!=="object"){return null}if(data.device_token!=null){this.deviceToken=data.device_token}if(data.device_type!=null){return this.deviceType=data.device_type}};return Installation}();ECHO.ContentsCategoriesMap=function(superClass){extend(ContentsCategoriesMap,superClass);function ContentsCategoriesMap(instanceId,refid,data){if(refid==null){refid=null}if(data==null){data=null}ContentsCategoriesMap.__super__.constructor.call(this,instanceId,"categories",refid,data)}ContentsCategoriesMap.prototype._copyData=function(data){var categories,category;if(!((data!=null?data.categories:void 0)instanceof Object)){return null}categories=data.categories;if(this._isSubtree){if(!(categories[0]instanceof Object)){return null}category=categories[0];if(category.refid==null||!category.refid){return null}this.children=this._makeChildren(category.children);return this.node=new ECHO.ContentsCategoryObject(this.instanceId,category.refid,category)}else{return this.children=this._makeChildren(categories)}};ContentsCategoriesMap.prototype._makeChildren=function(categories){var category,childList,key,map;childList=[];if(categories instanceof Object){for(key in categories){category=categories[key];if(!(category instanceof Object)){continue}if(category.refid==null||!category.refid){continue}map=new ECHO.ContentsCategoriesMap(this.instanceId,category.refid,{categories:[category]});childList.push(map)}}return childList};return ContentsCategoriesMap}(ECHOTreeMap);ECHO.ContentsCategoryObject=function(superClass){extend(ContentsCategoryObject,superClass);function ContentsCategoryObject(instanceId,refid,data){if(refid==null){refid=null}if(data==null){data=null}ContentsCategoryObject.__super__.constructor.call(this,instanceId,"categories",refid,data);this._newParent=null}ContentsCategoryObject.prototype.setNewParent=function(newParent){if(!(newParent instanceof ECHO.ContentsCategoryObject)){throw new TypeError("Invalid data type for argument `newParent`.")}return this._newParent=newParent};ContentsCategoryObject.prototype._buildRequestContents=function(){var data,new_parent_refid,ref,ref1;data=ContentsCategoryObject.__super__._buildRequestContents.call(this);new_parent_refid=(ref=(ref1=this._newParent)!=null?ref1.refid:void 0)!=null?ref:null;if(new_parent_refid!=null){data.parent_refid=new_parent_refid}return data};ContentsCategoryObject.prototype._copyData=function(data){var base,category;if(!(data instanceof Object)){return null}if(data.categories!=null){category=typeof(base=data.categories)[0]==="function"?base[0](null):void 0}else{category=data}if((category!=null?category.children:void 0)!=null){delete category.children}ContentsCategoryObject.__super__._copyData.call(this,category);return null};return ContentsCategoryObject}(ECHODataObject);ECHO.Blogs=function(){function Blogs(){}Blogs.find=function(instanceId,params){return ECHOQuery.find(instanceId,"archive",params,"entries")};return Blogs}();ECHO.Blogs.EntryObject=function(superClass){extend(EntryObject,superClass);function EntryObject(instanceId,refid,data){if(refid==null){refid=null}if(data==null){data=null}EntryObject.__super__.constructor.call(this,instanceId,"entry",refid,data)}EntryObject.prototype._copyData=function(data){if(data.published!=null){data.published=dateFromString(data.published)}EntryObject.__super__._copyData.call(this,data);return null};EntryObject.prototype._buildRequestContents=function(){var data;data=EntryObject.__super__._buildRequestContents.call(this);if((data.published!=null)instanceof Date){data.published=stringFromDate(data.published)}return data};return EntryObject}(ECHOContentsObject);ECHO.Databases=function(){function Databases(){}Databases.find=function(instanceId,params){if(params==null){params={}}return ECHOQuery.find(instanceId,"archive",params,"records")};return Databases}();ECHO.Databases.RecordObject=function(superClass){extend(RecordObject,superClass);function RecordObject(instanceId,refid,data){if(refid==null){refid=null}if(data==null){data=null}RecordObject.__super__.constructor.call(this,instanceId,"record",refid,data)}return RecordObject}(ECHOContentsObject);ECHO.Members=function(superClass){extend(Members,superClass);function Members(){return Members.__super__.constructor.apply(this,arguments)}Members.find=function(instanceId,params){if(params==null){params={}}return ECHOQuery.find(instanceId,"list",params,"members")};Members.login=function(instanceId,loginId,password){var data,promise,promise2;data={login_id:loginId,password:password};promise=ECHOQuery.request("POST","/"+instanceId+"/login",data);promise2=new ECHO.Promise;promise.then(function(retObj){var member,ref;if((retObj!=null?retObj.refid:void 0)==null){return null}member=new ECHO.Members.MemberObject(instanceId,retObj.refid,retObj);ECHO.accessToken=(ref=retObj.access_token)!=null?ref:null;return promise2.resolve(member)},function(error){return promise2.reject(error)});return promise2};Members.logout=function(instanceId){var promise,promise2;promise=ECHOQuery.request("POST","/"+instanceId+"/login",{});promise2=new ECHO.Promise;promise.then(function(retObj){return promise2.resolve(null)},function(error){return promise2.reject(error)});return promise2};return Members}(ECHODataObject);ECHO.Members.MemberObject=function(superClass){extend(MemberObject,superClass);function MemberObject(instanceId,refid,data){if(refid==null){refid=null}if(data==null){data=null}MemberObject.__super__.constructor.call(this,instanceId,"member",refid,data)}MemberObject.prototype._copyData=function(data){var group,i,j,len,ref;if(data.last_logined!=null){data.last_logined=dateFromString(data.last_logined)}if(data.groups!=null){ref=data.groups;for(i=j=0,len=ref.length;j<len;i=++j){group=ref[i];if(group.refid!=null){data.groups[i]=new ECHO.Members.GroupObject(this.instanceId,group.refid,group)}}}if(data.installation!=null){data.installation=new ECHO.Installation(data.installation)}MemberObject.__super__._copyData.call(this,data);return null};MemberObject.prototype._buildRequestContents=function(){var data,group,i,j,len,ref;data=MemberObject.__super__._buildRequestContents.call(this);delete(data.last_logined!=null);if(data.groups!=null){ref=data.groups;for(i=j=0,len=ref.length;j<len;i=++j){group=ref[i];if(group.refid!=null){data.groups[i]=group.refid}}}if(data.installation!=null&&data.installation instanceof ECHO.Installation){data.installation=data.installation.toObject()}return data};return MemberObject}(ECHODataObject);ECHO.Members.GroupsMap=function(superClass){extend(GroupsMap,superClass);function GroupsMap(instanceId,refid,data){if(refid==null){refid=null}if(data==null){data=null}GroupsMap.__super__.constructor.call(this,instanceId,"groups",refid,data)}GroupsMap.prototype._copyData=function(data){var group,groups;if(!((data!=null?data.groups:void 0)instanceof Object)){return null}groups=data.groups;if(this._isSubtree){if(!(groups[0]instanceof Object)){return null}group=groups[0];if(group.refid==null||!group.refid){return null}this.children=this._makeChildren(group.children);return this.node=new ECHO.Members.GroupObject(this.instanceId,group.refid,group)}else{return this.children=this._makeChildren(groups)}};GroupsMap.prototype._makeChildren=function(groups){var childList,group,j,len,map;childList=[];if(groups instanceof Object){for(j=0,len=groups.length;j<len;j++){group=groups[j];if(!(group instanceof Object)){return null}if((group!=null?group.refid:void 0)==null||!group.refid){return null}map=new ECHO.Members.GroupsMap(this.instanceId,group.refid,{groups:[group]});childList.push(map)}}return childList};return GroupsMap}(ECHOTreeMap);ECHO.Members.GroupObject=function(superClass){extend(GroupObject,superClass);function GroupObject(instanceId,refid,data){if(refid==null){refid=null}if(data==null){data=null}GroupObject.__super__.constructor.call(this,instanceId,"groups",refid,data);this._newParent=null}GroupObject.prototype.setNewParent=function(newParent){if(!(newParent instanceof ECHO.Members.GroupObject)){throw new TypeError("Invalid data type for argument `newParent`.")}return this._newParent=newParent};GroupObject.prototype._buildRequestContents=function(){var data,new_parent_refid,ref,ref1;data=GroupObject.__super__._buildRequestContents.call(this);new_parent_refid=(ref=(ref1=this._newParent)!=null?ref1.refid:void 0)!=null?ref:null;if(new_parent_refid!=null){data.parent_refid=new_parent_refid}return data};GroupObject.prototype._copyData=function(data){var base,group;if(!(data instanceof Object)){return null}if(data.groups!=null){group=typeof(base=data.groups)[0]==="function"?base[0](null):void 0}else{group=data}if((group!=null?group.children:void 0)!=null){delete group.children}GroupObject.__super__._copyData.call(this,group);return null};return GroupObject}(ECHODataObject);ECHO.Members.MailmagObject=function(superClass){extend(MailmagObject,superClass);function MailmagObject(instanceId,refid,data){if(refid==null){refid=null}if(data==null){data=null}MailmagObject.__super__.constructor.call(this,instanceId,"mailmag",refid,data)}return MailmagObject}(ECHODistributedObject);ECHO.Members.PushNotificationObject=function(superClass){extend(PushNotificationObject,superClass);function PushNotificationObject(instanceId,refid,data){if(refid==null){refid=null}if(data==null){data=null}PushNotificationObject.__super__.constructor.call(this,instanceId,"push_notification",refid,data)}return PushNotificationObject}(ECHODistributedObject);if(typeof module!=="undefined"&&module!==null?module.exports:void 0){module.exports=ECHO}else{this.ECHO=ECHO}typeIsArray=function(value){return value&&typeof value==="object"&&value instanceof Array&&typeof value.length==="number"&&typeof value.splice==="function"&&!value.propertyIsEnumerable("length")};typeIsString=function(value){return typeof value==="string"||value instanceof String};dateFromString=function(dateStr){var d;if(!typeIsString(dateStr)){throw new TypeError("Invalid data type for argument `dateStr`.")}d=dateStr.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2}) ([0-9]{2}):([0-9]{2}):([0-9]{2})$/);if(d==null){throw new TypeError("Invalid date string format for argument `dateStr`.")}return new Date(Date.UTC(d[1],d[2]-1,d[3],d[4],d[5],d[6],0))};stringFromDate=function(dateObj){var date,hour,min,month,sec,year;if(!(dateObj instanceof Date)){throw new TypeError("Invalid data type for argument `dateObj`.")}year=dateObj.getUTCFullYear();month=dateObj.getUTCMonth()+1;date=dateObj.getUTCDate();hour=dateObj.getUTCHours();min=dateObj.getUTCMinutes();sec=dateObj.getUTCSeconds();return year+"-"+month+"-"+date+" "+hour+":"+min+":"+sec}}).call(this);(function(){if(typeof module!=="undefined"&&module!==null?module.exports:void 0){var Url=require("url");var spawn=require("child_process").spawn;var fs=require("fs");XMLHttpRequest=function(){"use strict";var self=this;var http=require("http");var https=require("https");var request;var response;var settings={};var disableHeaderCheck=false;var defaultHeaders={"User-Agent":"node-XMLHttpRequest",Accept:"*/*"};var headers=defaultHeaders;var forbiddenRequestHeaders=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","content-transfer-encoding","cookie","cookie2","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"];var forbiddenRequestMethods=["TRACE","TRACK","CONNECT"];var sendFlag=false;var errorFlag=false;var listeners={};this.UNSENT=0;this.OPENED=1;this.HEADERS_RECEIVED=2;this.LOADING=3;this.DONE=4;this.readyState=this.UNSENT;this.onreadystatechange=null;this.responseText="";this.responseXML="";this.status=null;this.statusText=null;var isAllowedHttpHeader=function(header){return disableHeaderCheck||header&&forbiddenRequestHeaders.indexOf(header.toLowerCase())===-1};var isAllowedHttpMethod=function(method){return method&&forbiddenRequestMethods.indexOf(method)===-1};this.open=function(method,url,async,user,password){this.abort();errorFlag=false;if(!isAllowedHttpMethod(method)){throw"SecurityError: Request method not allowed"}settings={method:method,url:url.toString(),async:typeof async!=="boolean"?true:async,user:user||null,password:password||null};setState(this.OPENED)};this.setDisableHeaderCheck=function(state){disableHeaderCheck=state};this.setRequestHeader=function(header,value){if(this.readyState!==this.OPENED){throw"INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN"}if(!isAllowedHttpHeader(header)){console.warn('Refused to set unsafe header "'+header+'"');return}if(sendFlag){throw"INVALID_STATE_ERR: send flag is true"}headers[header]=value};this.getResponseHeader=function(header){if(typeof header==="string"&&this.readyState>this.OPENED&&response&&response.headers&&response.headers[header.toLowerCase()]&&!errorFlag){return response.headers[header.toLowerCase()]}return null};this.getAllResponseHeaders=function(){if(this.readyState<this.HEADERS_RECEIVED||errorFlag){return""}var result="";for(var i in response.headers){if(i!=="set-cookie"&&i!=="set-cookie2"){result+=i+": "+response.headers[i]+"\r\n"}}return result.substr(0,result.length-2)};this.getRequestHeader=function(name){if(typeof name==="string"&&headers[name]){return headers[name]}return""};this.send=function(data){if(this.readyState!==this.OPENED){throw"INVALID_STATE_ERR: connection must be opened before send() is called"}if(sendFlag){throw"INVALID_STATE_ERR: send has already been called"}var ssl=false,local=false;var url=Url.parse(settings.url);var host;switch(url.protocol){case"https:":ssl=true;case"http:":host=url.hostname;break;case"file:":local=true;break;case undefined:case"":host="localhost";break;default:throw"Protocol not supported."}if(local){if(settings.method!=="GET"){throw"XMLHttpRequest: Only GET method is supported"}if(settings.async){fs.readFile(url.pathname,"utf8",function(error,data){if(error){self.handleError(error)}else{self.status=200;self.responseText=data;setState(self.DONE)}})}else{try{this.responseText=fs.readFileSync(url.pathname,"utf8");this.status=200;setState(self.DONE)}catch(e){this.handleError(e)}}return}var port=url.port||(ssl?443:80);var uri=url.pathname+(url.search?url.search:"");headers.Host=host;if(!(ssl&&port===443||port===80)){headers.Host+=":"+url.port}if(settings.user){if(typeof settings.password==="undefined"){settings.password=""}var authBuf=new Buffer(settings.user+":"+settings.password);headers.Authorization="Basic "+authBuf.toString("base64")}var formData=data&&data.pipe&&data.getHeaders&&data.getLengthSync;if(settings.method==="GET"||settings.method==="HEAD"){data=null}else if(formData){headers["Content-Length"]=data.getLengthSync();headers["Content-Type"]=data.getHeaders()["content-type"]}else if(data){headers["Content-Length"]=Buffer.isBuffer(data)?data.length:Buffer.byteLength(data);if(!headers["Content-Type"]){headers["Content-Type"]="text/plain;charset=UTF-8"}}else if(settings.method==="POST"){headers["Content-Length"]=0}var options={host:host,port:port,path:uri,method:settings.method,headers:headers,agent:false};errorFlag=false;if(settings.async){var doRequest=ssl?https.request:http.request;sendFlag=true;self.dispatchEvent("readystatechange");var responseHandler=function responseHandler(resp){response=resp;if(response.statusCode===301||response.statusCode===302||response.statusCode===303||response.statusCode===307){settings.url=response.headers.location;var url=Url.parse(settings.url);host=url.hostname;var newOptions={hostname:url.hostname,port:url.port,path:url.path,method:response.statusCode===303?"GET":settings.method,headers:headers};request=doRequest(newOptions,responseHandler).on("error",errorHandler);request.end();return}response.setEncoding("utf8");setState(self.HEADERS_RECEIVED);self.status=response.statusCode;response.on("data",function(chunk){if(chunk){self.responseText+=chunk}if(sendFlag){setState(self.LOADING)}});response.on("end",function(){if(sendFlag){setState(self.DONE);sendFlag=false}});response.on("error",function(error){self.handleError(error)})};var errorHandler=function errorHandler(error){self.handleError(error)};request=doRequest(options,responseHandler).on("error",errorHandler);if(formData){data.pipe(request)}else if(data){request.write(data)}request.end();self.dispatchEvent("loadstart")}else{var contentFile=".node-xmlhttprequest-content-"+process.pid;var syncFile=".node-xmlhttprequest-sync-"+process.pid;fs.writeFileSync(syncFile,"","utf8");var execString="var http = require('http'), https = require('https'), fs = require('fs');"+"var doRequest = http"+(ssl?"s":"")+".request;"+"var options = "+JSON.stringify(options)+";"+"var responseText = '';"+"var req = doRequest(options, function(response) {"+"response.setEncoding('utf8');"+"response.on('data', function(chunk) {"+"  responseText += chunk;"+"});"+"response.on('end', function() {"+"fs.writeFileSync('"+contentFile+"', JSON.stringify({err: null, data: {statusCode: response.statusCode, headers: response.headers, text: responseText}}), 'utf8');"+"fs.unlinkSync('"+syncFile+"');"+"});"+"response.on('error', function(error) {"+"fs.writeFileSync('"+contentFile+"', JSON.stringify({err: error}), 'utf8');"+"fs.unlinkSync('"+syncFile+"');"+"});"+"}).on('error', function(error) {"+"fs.writeFileSync('"+contentFile+"', JSON.stringify({err: error}), 'utf8');"+"fs.unlinkSync('"+syncFile+"');"+"});"+(data?"req.write('"+JSON.stringify(data).slice(1,-1).replace(/'/g,"\\'")+"');":"")+"req.end();";var syncProc=spawn(process.argv[0],["-e",execString]);while(fs.existsSync(syncFile)){}var resp=JSON.parse(fs.readFileSync(contentFile,"utf8"));syncProc.stdin.end();fs.unlinkSync(contentFile);if(resp.err){self.handleError(resp.err)}else{response=resp.data;self.status=resp.data.statusCode;self.responseText=resp.data.text;setState(self.DONE)}}};this.handleError=function(error){this.status=503;this.statusText=error;this.responseText=error.stack;errorFlag=true;setState(this.DONE)};this.abort=function(){if(request){request.abort();request=null}headers=defaultHeaders;this.responseText="";this.responseXML="";errorFlag=true;if(this.readyState!==this.UNSENT&&(this.readyState!==this.OPENED||sendFlag)&&this.readyState!==this.DONE){sendFlag=false;setState(this.DONE)}this.readyState=this.UNSENT};this.addEventListener=function(event,callback){if(!(event in listeners)){listeners[event]=[]}listeners[event].push(callback)};this.removeEventListener=function(event,callback){if(event in listeners){listeners[event]=listeners[event].filter(function(ev){return ev!==callback})}};this.dispatchEvent=function(event){if(typeof self["on"+event]==="function"){self["on"+event]()}if(event in listeners){for(var i=0,len=listeners[event].length;i<len;i++){listeners[event][i].call(self)}}};var setState=function(state){if(state==self.LOADING||self.readyState!==state){self.readyState=state;if(settings.async||self.readyState<self.OPENED||self.readyState===self.DONE){self.dispatchEvent("readystatechange")}if(self.readyState===self.DONE&&!errorFlag){self.dispatchEvent("load");self.dispatchEvent("loadend")}}}}}}).call(this);